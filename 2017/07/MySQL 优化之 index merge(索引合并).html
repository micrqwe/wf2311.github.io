<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta name="google-site-verification" content="PR6S72-htn-N1oDn9ENMcwi5niLKk0uebDzmRS-oivs"><meta property="wb:webmaster" content="320520520031fedd"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>MySQL 优化之 index merge(索引合并) | 王峰的博客</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" href="../../css/index.css"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css?t=1574166127270"><link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.6/jquery.fancybox.min.css?t=1574166127270"><link rel="stylesheet" type="text/css" href="../../css/style.css?t=1574166127270"><!--link(rel='stylesheet', type='text/css', href=url_for(theme.css) + '/highlight.css' + '?v=' + theme.version)--><link rel="Shortcut Icon" href="https://file.wf2311.com/favicon.ico"><link rel="bookmark" href="https://file.wf2311.com/favicon.ico"><link rel="apple-touch-icon" href="../../apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="../../apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="../../atom.xml"><script type="text/javascript">window.GLOBAL_CONFIG = {
    root: '/',
    copy: {
        success: '复制成功',
        error: '复制错误',
        noSupport: '浏览器不支持'
    }
}</script><script type="text/javascript">!function (e, t, n, g, i) {
    e[i] = e[i] || function () {
        (e[i].q = e[i].q || []).push(arguments)
    }, n = t.createElement("script"), tag = t.getElementsByTagName("script")[0], n.async = 1, n.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + g, tag.parentNode.insertBefore(n, tag)
}(window, document, "script", "assets.growingio.com/2.1/gio.js", "gio");
gio('init', 'a2a964d9c5ed28c0', {})
gio('send');</script></head><script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script><script src="https://cdn.bootcss.com/fancybox/3.5.6/jquery.fancybox.min.js"></script><script src="https://cdn.bootcss.com/velocity/1.5.2/velocity.min.js"></script><script src="https://cdn.bootcss.com/velocity/1.5.2/velocity.ui.min.js"></script><!--if theme.scripts !== undefined && theme.scripts.length > 0--><script src="../../js/utils.js?t=1574166127270"></script><script src="../../js/copy.js?t=1574166127270"></script><script src="../../js/common.js?t=1574166127270"></script><body><!--canvas.fireworks--><div class="nav"><div id="nav-menu"><div class="nav-left"><a href="../../." class="current"><i class="fa fa-home"> 首页</i></a><a href="../../archives/" target="_self"><i class="fa fa-archive"> 归档</i></a><a href="../../books/" target="_self"><i class="fa fa-book"> 书单</i></a></div><div class="nav-right"><a href="https://wakatime.wangfeng.pro" target="_blank"><i class="fa fa-bar-chart"> WakaTime</i></a></div><br><div id="nav-sub-menu"></div></div></div><div class="body_container"><div id="header"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><span title="转载" class="article-icon article-icon-3">转</span><h1 class="post-title">MySQL 优化之 index merge(索引合并) </h1><div class="post-meta"><a href="#saveImg" class="saveImg-icon"></a><a href="#comments" class="comment-count"></a><p><span class="date">2017-07-14</span><span><a href="../../categories/数据库/" class="category">数据库</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span><span class="fa fa-user"> digdeep</span><span> 共2,950字，阅读约需13分钟</span></p></div><div id="post-content" class="post-content"><blockquote class="article-reprint-info"><div>原文由 <b>digdeep</b><span> 发表于 </span><a href="https://www.cnblogs.com/digdeep/p/4975977.html">https://www.cnblogs.com/digdeep/p/4975977.html</a><span>，版权归原作者所有。</span></div></blockquote><blockquote>
<p>深入理解 index merge 是使用索引进行优化的重要基础之一。理解了 index merge 技术，我们才知道应该如何在表上建立索引。<br><a id="more"></a></p>
</blockquote>
<h2 id="1-为什么会有index-merge"><a href="#1-为什么会有index-merge" class="headerlink" title="1.为什么会有index merge"></a>1.为什么会有index merge</h2><p>我们的 where 中可能有多个条件(或者join)涉及到多个字段，它们之间进行 AND 或者 OR，那么此时就有可能会使用到 index merge 技术。index merge 技术如果简单的说，其实就是：对多个索引分别进行条件扫描，然后将它们各自的结果进行合并(intersect/union)。</p>
<p>MySQL5.0之前，一个表一次只能使用一个索引，无法同时使用多个索引分别进行条件扫描。但是从5.1开始，引入了 index merge 优化技术，对同一个表可以使用多个索引分别进行条件扫描。</p>
<p>相关文档：<a href="http://dev.mysql.com/doc/refman/5.6/en/index-merge-optimization.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.6/en/index-merge-optimization.html</a> (注意该文档中说的有几处错误)</p>
<p>The Index Merge method is used to retrieve rows with several range scans and to merge their results into one. The merge can produce unions, intersections, or unions-of-intersections of its underlying scans. This access method merges index scans from a single table; it does not merge scans across multiple tables.</p>
<p>In EXPLAIN output, the Index Merge method appears as index_merge in the type column. In this case, the key column contains a list of indexes used, and key_len contains a list of the longest key parts for those indexes.</p>
<p>index merge: 同一个表的多个索引的范围扫描可以对结果进行合并，合并方式分为三种：union, intersection, 以及它们的组合(先内部intersect然后在外面union)。</p>
<p>官方文档给出了四个例子：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> key1 = <span class="number">10</span> <span class="keyword">OR</span> key2 = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> (key1 = <span class="number">10</span> <span class="keyword">OR</span> key2 = <span class="number">20</span>) <span class="keyword">AND</span> non_key=<span class="number">30</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1, t2 <span class="keyword">WHERE</span> (t1.key1 <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>) <span class="keyword">OR</span> t1.key2 <span class="keyword">LIKE</span> <span class="string">'value%'</span>) <span class="keyword">AND</span> t2.key1=t1.some_col;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t1, t2 <span class="keyword">WHERE</span> t1.key1=<span class="number">1</span> <span class="keyword">AND</span> (t2.key1=t1.some_col <span class="keyword">OR</span> t2.key2=t1.some_col2);</span><br></pre></td></tr></table></figure></p>
<p>但是第四个例子，感觉并不会使用 index merge. 因为 t2.key1=t1.some_col 和 t2.key2=t1.some_col2 之间进行的是 OR 运算，而且 t2.key2 是复合索引的第二个字段(非第一个字段)。所以：t2.key2 = t1.some_col2 并不能使用到复合索引。(文档这里应该是错误的)</p>
<p>index merge 算法根据合并算法的不同分成了三种：intersect, union, sort_union. </p>
<h2 id="2-index-merge-之-intersect"><a href="#2-index-merge-之-intersect" class="headerlink" title="2.index merge 之 intersect"></a>2.index merge 之 intersect</h2><p>简单而言，index intersect merge就是多个索引条件扫描得到的结果进行交集运算。显然在多个索引提交之间是 AND 运算时，才会出现 index intersect merge. 下面两种where条件或者它们的组合时会进行 index intersect merge:</p>
<p>1) 条件使用到复合索引中的所有字段或者左前缀字段(对单字段索引也适用)</p>
<p>key_part1=const1 AND key_part2=const2 … AND key_partN=constN<br>2) 主键上的任何范围条件</p>
<p>例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> innodb_table <span class="keyword">WHERE</span> primary_key &lt; <span class="number">10</span> <span class="keyword">AND</span> key_col1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl_name <span class="keyword">WHERE</span> (key1_part1=<span class="number">1</span> <span class="keyword">AND</span> key1_part2=<span class="number">2</span>) <span class="keyword">AND</span> key2=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>上面只说到复合索引，但是其实单字段索引显然也是一样的。比如 select * from tab where key1=xx and key2 =xxx; 也是有可能进行index intersect merge的。另外上面两种情况的 AND 组合也一样可能会进行 index intersect merge.</p>
<p>The Index Merge intersection algorithm performs simultaneous scans on all used indexes and produces the intersection of row sequences that it receives from the merged index scans. (intersect merge运行方式：多个索引同时扫描，然后结果取交集)</p>
<p>If all columns used in the query are covered by the used indexes, full table rows are not retrieved (EXPLAIN output contains Using index in Extra field in this case). Here is an example of such a query:(索引覆盖扫描，无需回表)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> key1=<span class="number">1</span> <span class="keyword">AND</span> key2=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>If the used indexes do not cover all columns used in the query, full rows are retrieved only when the range conditions for all used keys are satisfied.(索引不能覆盖，则对满足条件的再进行回表)</p>
<p>If one of the merged conditions is a condition over a primary key of an InnoDB table, it is not used for row retrieval, but is used to filter out rows retrieved using other conditions.</p>
<h2 id="3-index-merge-之-union"><a href="#3-index-merge-之-union" class="headerlink" title="3.index merge 之 union"></a>3.index merge 之 union</h2><p>简单而言，index uion merge就是多个索引条件扫描，对得到的结果进行并集运算，显然是多个条件之间进行的是 OR 运算。</p>
<p>下面几种类型的 where 条件，以及他们的组合可能会使用到 index union merge算法：</p>
<p>1) 条件使用到复合索引中的所有字段或者左前缀字段(对单字段索引也适用)</p>
<p>2) 主键上的任何范围条件</p>
<p>3) 任何符合 index intersect merge 的where条件；</p>
<p>上面三种 where 条件进行 OR 运算时，可能会使用 index union merge算法。</p>
<p>例子：</p>
<p>SELECT <em> FROM t1 WHERE key1=1 OR key2=2 OR key3=3;<br>SELECT </em> FROM innodb_table WHERE (key1=1 AND key2=2) OR (key3=’foo’ AND key4=’bar’) AND key5=5;<br>第一个例子，就是三个 单字段索引 进行 OR 运算，所以他们可能会使用 index union merge算法。</p>
<p>第二个例子，复杂一点。(key1=1 AND key2=2) 是符合 index intersect merge; (key3=’foo’ AND key4=’bar’) AND key5=5 也是符合index intersect merge，所以 二者之间进行 OR 运算，自然可能会使用 index union merge算法。</p>
<h2 id="4-index-merge-之-sort-union"><a href="#4-index-merge-之-sort-union" class="headerlink" title="4.index merge 之 sort_union"></a>4.index merge 之 sort_union</h2><p>This access algorithm is employed when the WHERE clause was converted to several range conditions combined by OR, but for which the Index Merge method union algorithm is not applicable.(多个条件扫描进行 OR 运算，但是不符合 index union merge算法的，此时可能会使用 sort_union算法)</p>
<p>官方文档给出了两个例子：</p>
<p>SELECT <em> FROM tbl_name WHERE key_col1 &lt; 10 OR key_col2 &lt; 20;<br>SELECT </em> FROM tbl_name WHERE (key_col1 &gt; 10 OR key_col2 = 20) AND nonkey_col=30;<br>但是显然：因为 key_col2 不是复合索引的第一个字段，对它进行 OR 运算，是不可能使用到索引的。所以这两个例子应该也是错误的，它们实际上并不会进行 index sort_union merge算法。</p>
<p>The difference between the sort-union algorithm and the union algorithm is that the sort-union algorithm must first fetch row IDs for all rows and sort them before returning any rows.(sort-union合并算法和union合并算法的不同点，在于返回结果之前是否排序，为什么需要排序呢？可能是因为两个结果集，进行并集运算，需要去重，所以才进行排序？？？)</p>
<h2 id="5-index-merge的局限"><a href="#5-index-merge的局限" class="headerlink" title="5.index merge的局限"></a>5.index merge的局限</h2><p>1）If your query has a complex WHERE clause with deep AND/OR nesting and MySQL does not choose the optimal plan, try distributing terms using the following identity laws:</p>
<p>(x AND y) OR z = (x OR z) AND (y OR z)<br>(x OR y) AND z = (x AND z) OR (y AND z)<br>如果我们的条件比较复杂，用到多个 and / or 条件运算，而MySQL没有使用最优的执行计划，那么可以使用上面的两个等式将条件进行转换一下。</p>
<p>2）Index Merge is not applicable to full-text indexes. We plan to extend it to cover these in a future MySQL release.(全文索引没有index merge)</p>
<p>3）Before MySQL 5.6.6, if a range scan is possible on some key, the optimizer will not consider using Index Merge Union or Index Merge Sort-Union algorithms. For example, consider this query:</p>
<p>SELECT * FROM t1 WHERE (goodkey1 &lt; 10 OR goodkey2 &lt; 20) AND badkey &lt; 30;<br>For this query, two plans are possible:</p>
<p>An Index Merge scan using the (goodkey1 &lt; 10 OR goodkey2 &lt; 20) condition.</p>
<p>A range scan using the badkey &lt; 30 condition.</p>
<p>However, the optimizer considers only the second plan.</p>
<p>这一点对以低版本的MySQL是一个很大的缺陷。就是如果where条件中有 &gt;, &lt;, &gt;=, &lt;=等条件，那么优化器不会使用 index merge，而且还会忽略其他的索引，不会使用它们，哪怕他们的选择性更优。</p>
<h2 id="6-对-index-merge-的进一步优化"><a href="#6-对-index-merge-的进一步优化" class="headerlink" title="6.对 index merge 的进一步优化"></a>6.对 index merge 的进一步优化</h2><p>index merge使得我们可以使用到多个索引同时进行扫描，然后将结果进行合并。听起来好像是很好的功能，但是如果出现了 index intersect merge，那么一般同时也意味着我们的索引建立得不太合理，因为 index intersect merge 是可以通过建立 复合索引进行更一步优化的。</p>
<p>比如下面的select:</p>
<p>SELECT * FROM t1 WHERE key1=1 AND key2=2 AND key3=3;<br>显然我们是可以在这三个字段上建立一个复合索引来进行优化的，这样就只需要扫描一个索引一次，而不是对三个所以分别扫描一次。</p>
<p>percona官网有一篇 比较复合索引和index merge 的好文章：Multi Column indexes vs Index Merge</p>
<h2 id="7-复合索引的最左前缀原则"><a href="#7-复合索引的最左前缀原则" class="headerlink" title="7.复合索引的最左前缀原则"></a>7.复合索引的最左前缀原则</h2><p>上面我们说到，对复合索引的非最左前缀字段进行 OR 运算，是无法使用到复合索引的。比如：</p>
<p>SELECT * FROM tbl_name WHERE (key_col1 &gt; 10 OR key_col2 = 20) AND nonkey_col=30;<br>其原因是，MySQL中的索引，使用的是B+tree, 也就是说他是：先按照复合索引的 第一个字段的大小来排序，插入到 B+tree 中的，当第一个字段值相同时，在按照第二个字段的值比较来插入的。那么如果我们需要对： OR key_col2 = 20 这样的条件也使用复合索引，那么该怎么操作呢？应该要对复合索引进行全扫描，找出所有 key_col2 =20 的项，然后还要回表去判断 nonkey_col=30，显然代价太大了。所以一般而言 OR key_col2 = 20 这样的条件是无法使用到复合索引的。如果一定要使用索引，那么可以在 col2 上单独建立一个索引。</p>
<p>复合索引的最左前缀原则：</p>
<p>MySQL中的复合索引，查询时只会使用到最左前缀，比如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    mysql&gt; show index from role_goods;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    +------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">    | Table      | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |</span><br><span class="line">    +------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">    | role_goods |          0 | PRIMARY  |            1 | id          | A         |       22816 |     NULL | NULL   |      | BTREE      |         |               |</span><br><span class="line">    | role_goods |          1 | roleId   |            1 | roleId      | A         |        1521 |     NULL | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">    | role_goods |          1 | goodsId  |            1 | goodsId     | A         |        1521 |     NULL | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">    | role_goods |          1 | roleId_2 |            1 | roleId      | A         |        1901 |     NULL | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">    | role_goods |          1 | roleId_2 |            2 | status      | A         |        4563 |     NULL | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">    | role_goods |          1 | roleId_2 |            3 | number      | A         |       22816 |     NULL | NULL   | YES  | BTREE      |         |               |</span><br><span class="line">    +------------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>上面有一个复合索引：roleId_2(roleId,status,number)，如果条件是： where roleId=xxx and number=xxx，那么此时只会使用到最左前缀roleId，而不会使用到 number 来进行过滤。因为它们中间存在一个字段 status 没有出现在where条件中。实验如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from role_goods <span class="built_in">where</span> roleId=100000001 and status=1 and number=1 <span class="built_in">limit</span> 1;</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------------+------+-------+</span><br><span class="line">| id | select_type | table      | <span class="built_in">type</span> | possible_keys   | key      | key_len | ref               | rows | Extra |</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | role_goods | ref  | roleId,roleId_2 | roleId_2 | 23      | const,const,const |   13 | NULL  |</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------------+------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from role_goods <span class="built_in">where</span> roleId=100000001 and status=1 <span class="built_in">limit</span> 1;</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------+------+-------+</span><br><span class="line">| id | select_type | table      | <span class="built_in">type</span> | possible_keys   | key      | key_len | ref         | rows | Extra |</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------+------+-------+</span><br><span class="line">|  1 | SIMPLE      | role_goods | ref  | roleId,roleId_2 | roleId_2 | 14      | const,const |   13 | NULL  |</span><br><span class="line">+----+-------------+------------+------+-----------------+----------+---------+-------------+------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from role_goods <span class="built_in">where</span> roleId=100000001 and number=1 <span class="built_in">limit</span> 1;</span><br><span class="line">+----+-------------+------------+------+-----------------+--------+---------+-------+------+-------------+</span><br><span class="line">| id | select_type | table      | <span class="built_in">type</span> | possible_keys   | key    | key_len | ref   | rows | Extra       |</span><br><span class="line">+----+-------------+------------+------+-----------------+--------+---------+-------+------+-------------+</span><br><span class="line">|  1 | SIMPLE      | role_goods | ref  | roleId,roleId_2 | roleId | 9       | const |   14 | Using <span class="built_in">where</span> |</span><br><span class="line">+----+-------------+------------+------+-----------------+--------+---------+-------+------+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line">mysql&gt; explain select * from role_goods ignore index(roleId) <span class="built_in">where</span> roleId=100000001 and number=1 <span class="built_in">limit</span> 1;</span><br><span class="line">+----+-------------+------------+------+---------------+----------+---------+-------+------+-----------------------+</span><br><span class="line">| id | select_type | table      | <span class="built_in">type</span> | possible_keys | key      | key_len | ref   | rows | Extra                 |</span><br><span class="line">+----+-------------+------------+------+---------------+----------+---------+-------+------+-----------------------+</span><br><span class="line">|  1 | SIMPLE      | role_goods | ref  | roleId_2      | roleId_2 | 9       | const |   14 | Using index condition |</span><br><span class="line">+----+-------------+------------+------+---------------+----------+---------+-------+------+-----------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>key_len</code> 的变化：</p>
<p>显然最后一个查询仅仅使用到符合索引中的 roleId, 没有使用到 number. number使用在了 index conditon(也就是索引的push down技术)</p>
<p>注意最左前缀，并不是是指：一定要按照各个字段出现在where中的顺序来建立复合索引的。比如<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where status=2 and roleId=xxx and number = xxx</span><br></pre></td></tr></table></figure></p>
<p>该条件建立符合索引，我们并不需要按照status,roleId，number它们出现的顺序来建立索引：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> role_goods <span class="keyword">add</span> <span class="keyword">index</span> <span class="keyword">sin</span>(<span class="keyword">status</span>,roleId,<span class="built_in">number</span>)</span><br></pre></td></tr></table></figure></p>
<p>这是对最左前缀极大的误解。因为 <code>where status=2 and roleId=xxx and number = xxx 和 where roleId=xxx and number = xxx and status=2</code>它们是等价的。复合索引，哪个字段放在最前面，需要根据哪个字段经常出现在where条件中，哪个字段的选择性最好来判断的。</p>
<p>进一步可以参考的文章：</p>
<p><a href="http://www.orczhou.com/index.php/2013/01/mysql-source-code-query-optimization-index-merge/" title="http://www.orczhou.com/index.php/2013/01/mysql-source-code-query-optimization-index-merge/" target="_blank" rel="noopener">http://www.orczhou.com/index.php/2013/01/mysql-source-code-query-optimization-index-merge/</a></p>
<p><a href="http://www.cnblogs.com/nocode/archive/2013/01/28/2880654.html" title="http://www.cnblogs.com/nocode/archive/2013/01/28/2880654.html" target="_blank" rel="noopener">http://www.cnblogs.com/nocode/archive/2013/01/28/2880654.html</a></p>
</div><div class="tags"><a href="../../tags/MySQL/">MySQL</a><a href="../../tags/索引/">索引</a></div><div class="article-footer-copyright"><url><li>版权声明：本文由 <b>digdeep</b><span> 发表于 </span><a href="https://www.cnblogs.com/digdeep/p/4975977.html">https://www.cnblogs.com/digdeep/p/4975977.html</a></li><li>本文版权归原作者所有，如有侵权请立即与我联系，我将立即删除。</li><li id="blogTitleCp">文章标题：<a style="word-wrap:break-word">MySQL 优化之 index merge(索引合并)</a></li><li>文章链接：<a id="blogLink" style="word-wrap:break-word"></a><script>var blogLink = decodeURI(window.location.href);
var doc = document.getElementById('blogLink');
doc.setAttribute("href", blogLink);
doc.innerHTML=blogLink;</script></li></url></div><div class="post-share"><!--include _partial/save_img--><div id="share" class="soshm social-share"><span style="float:center;font-size:20px;font-weight:solid;color:gray">分享：</span></div></div><div class="post-nav"><a href="使用Thymeleaf变量给onclick属性赋值.html" class="pre">使用Thymeleaf变量给onclick属性赋值</a><a href="../05/在SpringBoot里面使用Thymeleaf3.html" class="next">在SpringBoot里面使用Thymeleaf3</a></div><div id="comments"><div id="vcomments"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-bars"> 文章目录</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('toc', 'toc-expand', 'none')"><span id="toc-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-为什么会有index-merge"><span class="toc-text">1.为什么会有index merge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-index-merge-之-intersect"><span class="toc-text">2.index merge 之 intersect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-index-merge-之-union"><span class="toc-text">3.index merge 之 union</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-index-merge-之-sort-union"><span class="toc-text">4.index merge 之 sort_union</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-index-merge的局限"><span class="toc-text">5.index merge的局限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-对-index-merge-的进一步优化"><span class="toc-text">6.对 index merge 的进一步优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-复合索引的最左前缀原则"><span class="toc-text">7.复合索引的最左前缀原则</span></a></li></ol></div><div class="widget"><div class="widget-title"><a href="../../index.html"><i class="fa fa-user">王峰的博客</i></a><a title="点击展开或收起条目" href="javascript:void(0)" onclick="showOrHide('info-list', 'info-list-expand', 'none')"><span id="info-list-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><ul class="post-list info-list"><li style="text-align:center"><img src="https://file.wf2311.com/wf2311.png" class="avatar"><!--p(style="text-align:center")= "好好学习，天天搬砖"--><p style="text-align:center;padding-top: 10px"><i class="fa fa-lg fa-map-marker">杭州</i></p><hr style="height:0.1px;border:none;border-top:1px dashed #0066CC;"></li><li style="text-align:center" class="info-icon"><a href="mailto:work@wangfeng.pro" target="_blank" title="邮箱：work@wangfeng.pro" class="post-list-link"><i class="fa fa-lg fa-envelope"></i></a><a href="https://github.com/wf2311" target="_blank" title="Github：https://github.com/wf2311" class="post-list-link"><i class="fa fa-lg fa-github"></i></a><a href="https://gitee.com/wf2311" target="_blank" title="码云：https://gitee.com/wf2311" class="post-list-link"><i class="fa fa-lg fa-git"></i></a><a data-image="https://file.wf2311.com/wechat.jpeg" target="_blank" title="微信：wf_2311" class="post-list-link"><i class="fa fa-lg fa-weixin"></i></a><a data-image="https://file.wf2311.com/qq.jpeg" target="_blank" title="QQ：836219767" class="post-list-link"><i class="fa fa-lg fa-qq"></i></a><a href="https://weibo.com/wangfengpro" target="_blank" title="微博：wf2311" class="post-list-link"><i class="fa fa-lg fa-weibo"></i></a><div id="infoImage"></div></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-edit"> 最新文章(10)</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="../../2019/11/让处于事务中的特定代码在事务提交成功后再执行.html">让处于事务中的特定代码在事务提交成功后再执行</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/10/wakatime手动同步本地离线数据至服务器.html">wakatime手动同步本地离线数据至服务器</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/09/ssh快捷登录并执行命令.html">ssh快捷登录并执行命令</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/09/Mac中在升级ruby版本后colorls命令报错的解决办法.html">Mac中在升级ruby版本后colorls命令报错的解决办法</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/彻底搞懂字符串比较问题和String.intern()方法的作用.html">彻底搞懂字符串比较问题和String.intern()方法的作用</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/使用正则表达式解析Nginx默认日志.html">使用正则表达式解析Nginx默认日志</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/Java虚拟机结构(二):内存结构概述.html">Java虚拟机结构(二):内存结构概述</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/Java虚拟机结构(一):数据类型.html">Java虚拟机结构(一):数据类型</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/《从零学习JVM》目录.html">《从零学习JVM》目录</a></li><li class="post-list-item"><a class="post-list-link" href="../../2019/01/如何优雅地在Hexo博客中嵌入SVG文件.html">如何优雅地在Hexo博客中嵌入SVG文件</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-align-left"> 分类(14)</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('category-list-child', 'category-expand', 'none')"><span id="category-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="../../categories/Java/">Java</a><span class="category-list-count">12</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="../../categories/Java/JVM/">JVM</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="../../categories/Java/JVM/从零学习JVM/">从零学习JVM</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="../../categories/Java/Java-Web/">Java Web</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="../../categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../categories/Mac/">Mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../categories/Maven/">Maven</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../categories/Spring/">Spring</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="../../categories/Spring/SpringBoot/">SpringBoot</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="../../categories/其它/">其它</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="../../categories/其它/命令/">命令</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="../../categories/前端/">前端</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="../../categories/数据库/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="../../categories/算法/">算法</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-tag"> 标签墙(41)</i><a title="点击展开或隐藏分类" href="javascript:void(0)" onclick="showOrHide('tagcloud', 'tag-expand', 'none')"><span id="tag-expand" style="font-size:12px;color:red"> 点击收起 </span></a></div><div class="tagcloud"><!--!= tagcloud({min_font: 15, max_font: 15, amount: 100, orderby: 'count'})--><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="../../tags/索引/">索引</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Java8/">Java8</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Stream/">Stream</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Nginx/">Nginx</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/笔记/">笔记</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Thread/">Thread</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Java/">Java</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/jQuery/">jQuery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Thymeleaf/">Thymeleaf</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Git/">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/命令/">命令</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Servlet/">Servlet</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/HttpServletRequest/">HttpServletRequest</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/SpringMvc/">SpringMvc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Maven/">Maven</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/MySQL/">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Enum/">Enum</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Json/">Json</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/远程调试/">远程调试</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Spring/">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/ApplicationEvent/">ApplicationEvent</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Docker/">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/JVM/">JVM</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/MAC/">MAC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/WakaTime/">WakaTime</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/工具/">工具</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/正则表达式/">正则表达式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/SVG/">SVG</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/String/">String</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/colorls/">colorls</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/gem/">gem</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/ssh/">ssh</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Aop/">Aop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/ThreadLocal/">ThreadLocal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../tags/Transactional/">Transactional</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档(32)</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2019/11/">十一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2019/09/">九月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2019/01/">一月 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2018/01/">一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/09/">九月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/07/">七月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../archives/2017/05/">五月 2017</a><span class="archive-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-link"> 友情链接</i></div><ul style="padding-top:10px"></ul><li style="padding-top:2px"><a href="https://liuyueyi.github.io/hexblog/" title="灰灰博客" target="_blank">灰灰博客</a></li><li style="padding-top:2px"><a href="https://www.skyli-blog.cn/" title="SkyLi" target="_blank">SkyLi</a></li></div></div></div></div><a id="totop" href="#top"></a><div id="renderShowBtn"><div><a id="renderShow" onclick="document.getElementById('render').style.display='block';document.getElementById('renderShowBtn').style.display='none';">渲染</a></div></div><div id="render"><script src="https://s3.mogucdn.com/mlcdn/c45406/1520387600580_dom-to-image.min.js" charset="utf-8"></script><div class="rInput"><input id="choose-id" type="text" placeholder="cid: | id: + 标签" onkeydown="if(event.keyCode==13) {doRender();}"></div><div class="rSendBtn"><a id="rImgBtn" onclick="doRender()">渲染</a></div></div><script type="text/javascript" src="../../js/render.js?t=1574166127304" async></script><div id="footer"><div class="footer-info"><p><span>本站总字数:28.6k</span><span>总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</span></p><p><span><span class="copyright">王峰 &copy; 2017 - 2019</span><span><a href="https://www.miitbeian.gov.cn/" target="_blank">鄂ICP备15002386号</a></span></span></p><p><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-85417096-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?97500f623f8c7cc9c77569130121cfa6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="../../js/search.json.js?t=1574166127430"></script><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js?t=1574166127430"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
  if(options){
    mermaid.initialize(options);
  }
}</script><script type="text/javascript" src="../../js/toctotop.js?t=1574166127430" async></script><script src="https://s3.mogucdn.com/mlcdn/c45406/1520407228303_social-share.min.js" charset="utf-8"></script><link rel="stylesheet" href="https://s3.mogucdn.com/mlcdn/c45406/1518422561591_share.min.css"><script src="https://unpkg.com/valine/dist/Valine.min.js"></script><script>new Valine({
    el: '#vcomments',
    appId: '6D0Mh4nGht9zbdbpUEWcUGYh-gzGzoHsz',
    appKey: 'zOr71Ml1wJrcFQQhzViNxIAx'
})</script></body></html>